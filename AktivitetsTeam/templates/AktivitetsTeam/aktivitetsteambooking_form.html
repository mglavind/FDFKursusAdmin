{% extends "base.html" %}
{% load static %}
{% load bootstrap_icons %}
{% block content %}

</br>
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'index' %}">Hjem</a></li>
      <li class="breadcrumb-item"><a href="{% url 'AktivitetsTeam_AktivitetsTeamBooking_list' %}">AktivitetsTeam bookinger</a></li>
      <li class="breadcrumb-item active" aria-current="page">Ny booking </li>
    </ol>
</nav>

</br>
<h1 class="display-3" >Ny Aktivitetsteam booking</h1>
{% if user.is_authenticated %}
<p>Deadline for Aktivitetsteam bestillinger: <mark> {{user.events.first.deadline_aktivitetsteam }} </mark>.</p>

{% endif %}
    
<form id="form" role="form" method="post">
    {% csrf_token %}
    
    {{ form.non_field_errors }}
    
    <div class="mb-3">
        {{ form.item.label_tag }}
        {{ form.item }}
        {{ form.item.errors }}
    </div>
    
    <div class="mb-3">
        {{ form.team.label_tag }}
        {{ form.team }}
        {{ form.team.errors }}
    </div>
    
    <div class="mb-3">
        {{ form.team_contact.label_tag }}
        {{ form.team_contact }}
        {{ form.team_contact.errors }}
    </div>
    
    <div class="mb-3">
        {{ form.quantity.label_tag }}
        {{ form.quantity }}
        {{ form.quantity.errors }}
    </div>
    
    <div class="mb-3">
        {{ form.remarks.label_tag }}
        {{ form.remarks }}
        {{ form.remarks.errors }}
    </div>
    
    <div class="mb-3">
        {{ form.location.label_tag }}
        {{ form.location }}
        {{ form.location.errors }}
    </div>
    
    <div class="mb-3">
        {{ form.start_date.label_tag }}
        {{ form.start_date }}
        {{ form.start_date.errors }}
    </div>
    
    <div class="mb-3">
        {{ form.start_time.label_tag }}
        {{ form.start_time }}
        {{ form.start_time.errors }}
    </div>
    
    <div class="mb-3">
        {{ form.end_date.label_tag }}
        {{ form.end_date }}
        {{ form.end_date.errors }}
    </div>
    
    <div class="mb-3">
        {{ form.end_time.label_tag }}
        {{ form.end_time }}
        {{ form.end_time.errors }}
    </div>
    
    <div class="mb-3">
        <label class="col-sm-2 col-form-label" for="latitude">Lat: </label>
        <input class="form-control"
        id="latitude" 
        name="latitude"
        type="text"
        value="{{ object.latitude}}">
    </div>

    <div class="mb-3">
        <label class="col-sm-2 col-form-label" for="longitude">Long: </label>
        <input class="form-control "
        type="text" 
        id="longitude" 
        name="longitude" 
        value="{{ object.longitude }}">
    </div>
    
    <div class="mb-3">
        {{ form.address.label_tag }}
        {{ form.address }}
        {{ form.address.errors }}
    </div>
    {{ object_dict|json_script:"object_json" }}
    <div id="map" style="height: 40em;" ></div>
    </br>

    <div class="form-group row">
        <div class="col-sm-10">
            <input type="submit" value="Gem" class="btn btn-primary">
        </div>
    </div>

</form>



<script>
    // Initialize object
    let objectElement = document.getElementById('object_json');
    let object = objectElement && objectElement.textContent ? JSON.parse(objectElement.textContent) : { latitude: null, longitude: null };
    console.log(object);

    var defaultLat = 56.114951;
    var defaultLng = 9.655592;

    // Ensure latitude and longitude are correctly formatted
    var initialLat = object.latitude !== null ? parseFloat(object.latitude.toString().replace(',', '.')) : defaultLat;
    var initialLng = object.longitude !== null ? parseFloat(object.longitude.toString().replace(',', '.')) : defaultLng;

    var map = L.map('map').setView([initialLat, initialLng], 15);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // Add a marker at the initial location
    var marker = L.marker([initialLat, initialLng]).addTo(map);

    // Update form fields with marker's initial position
    document.getElementById('latitude').value = initialLat;
    document.getElementById('longitude').value = initialLng;

    // Update marker and form fields on map click
    map.on('click', function(e) {
        e.originalEvent.preventDefault(); // Prevent default form submission behavior
        e.originalEvent.stopPropagation(); // Stop event propagation

        var lat = e.latlng.lat;
        var lng = e.latlng.lng;

        // Update marker position
        marker.setLatLng([lat, lng]);

        // Update form fields
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;

        return false; // Prevent any default behavior
    });

</script>
    {% endblock %}
